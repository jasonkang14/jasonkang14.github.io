{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/webrtc/stun-and-nat","result":{"data":{"markdownRemark":{"id":"6c7a7417-3946-521b-b57f-c595b1c48650","html":"<h1 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h1>\n<h3 id=\"nat의-종류에-따라-stun-서버가-제대로-작동하지-않을-수-있다\" style=\"position:relative;\"><a href=\"#nat%EC%9D%98-%EC%A2%85%EB%A5%98%EC%97%90-%EB%94%B0%EB%9D%BC-stun-%EC%84%9C%EB%B2%84%EA%B0%80-%EC%A0%9C%EB%8C%80%EB%A1%9C-%EC%9E%91%EB%8F%99%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%84-%EC%88%98-%EC%9E%88%EB%8B%A4\" aria-label=\"nat의 종류에 따라 stun 서버가 제대로 작동하지 않을 수 있다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NAT의 종류에 따라 STUN 서버가 제대로 작동하지 않을 수 있다.</h3>\n<p>WebRTC 처음 공부할 때 내렸던 결론은 STUN은 가끔 안 될 때가 있고, TURN은 왠만하면 된다 였다. 회사에 인턴 분들이 오시면서 WebRTC과제를 제공하는데, ICE server 설명 자료를 준비하다보니 왜 STUN이 안되는지 궁금해져서 찾아봤다.</p>\n<p><a href=\"https://www.ietf.org/rfc/rfc3489.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">STUN</a>의 기본적인 원리는, 본인의 Public IP를 모르는 client에게 Public IP 주소를 알려줌으로써, 이 Public IP를 통해 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RTCPeerConnection</a> 들이 소통할 수 있게 하는 것이다.</p>\n<p>따라서, STUN 서버로 통신할 수 없다는 것은 STUN server가 알려주는 Public IP의 주소가 제대로 작동하지 않는다는 것이다. 즉 클라이언트의 Private IP와 매핑된 Public IP로 통신이 불가능하다는 것이다.</p>\n<p>이걸 이해하기 위해서 NAT의 종류에 대해 찾아봤는데, 총 4가지가 있다고 한다. 순서대로 알아본다.</p>\n<ol>\n<li>\n<p>Full Cone NAT</p>\n<ul>\n<li>같은 private ip와 port를 가진 host는 같은 public ip와 port에 매핑된다</li>\n<li>따라서 외부에서 ip와 port에 상관없이 매핑된 public ip와 port를 통해 host에 요청을 보낼 수 있다.</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">   <span class=\"token punctuation\">{</span>NAT internal side<span class=\"token punctuation\">}</span>   <span class=\"token operator\">|</span>    <span class=\"token punctuation\">{</span>NAT external side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>  <span class=\"token punctuation\">{</span>Remote host<span class=\"token punctuation\">}</span>\n                         <span class=\"token operator\">|</span>                         <span class=\"token operator\">|</span>\n<span class=\"token number\">1</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token number\">2</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>- <span class=\"token punctuation\">(</span>   *    ,    *    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<ol start=\"2\">\n<li>Restricted Cone NAT\n<ul>\n<li>Full Cone NAT와 다르게 기존에 통신하던 IP가 아니라면 host로 패킷이 도달하지 않는다.</li>\n<li>Port Restricted Cone NAT과 구분하기 위해 Address Restricted Cone NAT이라고도 한다 -> IP 주소를 제한한다는 뜻</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    <span class=\"token punctuation\">{</span>NAT internal side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>    <span class=\"token punctuation\">{</span>NAT external side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>  <span class=\"token punctuation\">{</span>Remote host<span class=\"token punctuation\">}</span>\n                         <span class=\"token operator\">|</span>                         <span class=\"token operator\">|</span>\n<span class=\"token number\">1</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token number\">2</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>- <span class=\"token punctuation\">(</span>REM_ADDR,    *    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<ol start=\"3\">\n<li>\n<p>Port Restricted Cone NAT</p>\n<ul>\n<li>Restricted Cone NAT에서 한 단계 더 나아가 por 번호도 제한한다.</li>\n<li>기존에 통신하던 IP라고 하더라고 port 번호가 다르다면 통신할 수 없다.</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    <span class=\"token punctuation\">{</span>NAT internal side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>    <span class=\"token punctuation\">{</span>NAT external side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>  <span class=\"token punctuation\">{</span>Remote host<span class=\"token punctuation\">}</span>\n                         <span class=\"token operator\">|</span>                         <span class=\"token operator\">|</span>\n<span class=\"token number\">1</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token number\">2</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>- <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<ol start=\"4\">\n<li>\n<p>Symmetric NAT</p>\n<ul>\n<li>Port Restricted Cone NAT과 유사한데, 한 단계 더 나아가 outbound transmission마다 external side에서 새로운 port를 부여한다.</li>\n<li>internal side와 external side의 매핑이 지속적으로 바뀐다는 것이다.</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    <span class=\"token punctuation\">{</span>NAT internal side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>    <span class=\"token punctuation\">{</span>NAT external side<span class=\"token punctuation\">}</span>  <span class=\"token operator\">|</span>  <span class=\"token punctuation\">{</span>Remote host<span class=\"token punctuation\">}</span>\n                         <span class=\"token operator\">|</span>                         <span class=\"token operator\">|</span>\n<span class=\"token number\">1</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, EXT_PORT1<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token number\">2</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, EXT_PORT1<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>- <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">3</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, EXT_PORT2<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>\n<span class=\"token number\">4</span>. <span class=\"token punctuation\">(</span>INT_ADDR, INT_PORT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span>EXT_ADDR, EXT_PORT2<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>- <span class=\"token punctuation\">(</span>REM_ADDR, REM_PORT2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>STUN이 실패하는 가장 큰 이유가 바로 Symmetric NAT 때문이다. RTCPeerConnection이 다른 목적지로 패킷을 적용하면, external side port가 계속 바뀐다. 즉 STUN 서버로 요청을 보낼 때 사용된 external port가 다른 RTCPeerConnection과 소통하기 위해 사용된 external port와 다르기 때문이다. <a href=\"https://datatracker.ietf.org/doc/html/rfc3489\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC3489</a>에 따르면 STUN은 Full Cone NAT에서만 사용 가능하다. 그리고 Restricted Cone Nat과 Port Restricted Cone NAT의 경우 application 상태에 따라 가능하지만, Symmetric NAT의 경우에는 사용 가능한 public IP 주소를 return하지 않는다고 나와있다.</p>\n<p>이를 해결하기 위해 TURN이 사용되는데, TURN은 P2P통신은 아니고, RTCPeerConnection이 전달하는 패킷을 relay—전달 또는 배달—하는 역할을 한다. 다음에는 TURN에 대해 조금 더 자세히 공부해봐야겠다.</p>\n<p>참고자료</p>\n<ol>\n<li><a href=\"https://doc-kurento.readthedocs.io/en/stable/knowledge/nat.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://doc-kurento.readthedocs.io/en/stable/knowledge/nat.html</a></li>\n<li><a href=\"https://www.ietf.org/rfc/rfc3489\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.ietf.org/rfc/rfc3489</a></li>\n</ol>","fields":{"slug":"/posts/2022//webrtc/stun-and-nat","tagSlugs":["/tag/webrtc/"]},"frontmatter":{"date":"2022-04-22T18:53:37.121Z","description":"STUN 서버가 실패하는 이유는 무엇인가에 대해 알아본다","tags":["WebRTC"],"title":"STUN and NAT","socialImage":null}}},"pageContext":{"slug":"/posts/2022//webrtc/stun-and-nat"}},"staticQueryHashes":["251939775","288581551","401334301"]}