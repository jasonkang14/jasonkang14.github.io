<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.8"/><meta name="description" content="React 소스코드 분석을 통해 알아보는 JSX 렌더링" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta name="twitter:title" content="createRoot()에 render()를 호출하면 어떤 일이 일어날까? - Blog by Jason Kang" data-gatsby-head="true"/><meta name="twitter:description" content="React 소스코드 분석을 통해 알아보는 JSX 렌더링" data-gatsby-head="true"/><meta name="og:title" content="createRoot()에 render()를 호출하면 어떤 일이 일어날까? - Blog by Jason Kang" data-gatsby-head="true"/><meta name="og:type" content="website" data-gatsby-head="true"/><meta name="og:description" content="React 소스코드 분석을 통해 알아보는 JSX 렌더링" data-gatsby-head="true"/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><style data-href="/styles.462ccd878fdc76b93a3f.css" data-identity="gatsby-global-css">:after,:before,:root{--color-white:#fff;--color-primary:#5c92ff;--color-secondary:#f7a145;--color-prism-background:#eaeaeb;--color-typographic-base-font:#242933;--color-typographic-link-p-font:#5c92ff;--color-typographic-link-s-font:#f7a145;--color-page-border:#eaeaeb;--color-page-background:#fff;--color-sidebar-border:#eaeaeb;--color-sidebar-border-fade:#fff;--color-contacts-border:#eaeaeb;--color-button-border:#eaeaeb;--color-button-color:#242933;--color-theme-switcher:#3f485a;--color-theme-switcher-hover:#5c92ff}.dark :after,.dark :before,:root.dark{--color-white:#fff;--color-primary:#5c92ff;--color-secondary:#f7a145;--color-prism-background:#191d24;--color-typographic-base-font:#fff;--color-typographic-link-p-font:#5c92ff;--color-typographic-link-s-font:#f7a145;--color-page-border:#3f485a;--color-page-background:#242933;--color-sidebar-border:#3f485a;--color-sidebar-border-fade:#242933;--color-contacts-border:#3f485a;--color-button-border:#3f485a;--color-button-color:#fff;--color-theme-switcher:#eaeaeb;--color-theme-switcher-hover:#5c92ff}html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--color-page-background);color:var(--color-typographic-base-font);font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%);text-rendering:optimizelegibility}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#242933 0,#242933 15px,transparent 0,transparent 26px);background-size:100% 26px;color:var(--color-typographic-base-font);height:26px;margin:52px auto;width:100px}a{color:var(--color-typographic-link-p-font);text-decoration:none}a:active,a:focus,a:hover{color:var(--color-typographic-link-s-font)}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:var(--color-typographic-base-font);font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:var(--color-prism-background)}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.Feed-module--feed--a6204 .Feed-module--item--c7a63{margin-bottom:32.5px}.Feed-module--feed--a6204 .Feed-module--item--c7a63:last-child{margin-bottom:13px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b{color:var(--color-typographic-base-font)}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b:hover{border-bottom:1px solid #242933;color:var(--color-typographic-base-font)}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--description--57348{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--time--72864{color:var(--color-typographic-base-font);font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--divider--81a18{margin:0 13px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b{color:var(--color-secondary);font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b:hover{color:#5c92ff}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e{color:var(--color-primary);font-size:16px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e:hover{border-bottom:1px solid #5c92ff;color:var(--color-primary)}.Layout-module--layout--2c933{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--2c933:before{content:"";display:table}.Layout-module--layout--2c933:after{clear:both;content:"";display:table}.Page-module--page--24e03{margin-bottom:52px}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:26px 19.5px 0}.Page-module--page--24e03 .Page-module--title--90338{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--24e03 .Page-module--body--561c4{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--24e03{width:calc(58.275% - 12.5px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(12n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(12n+1){clear:both}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--24e03{width:calc(66.6% - 10px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(3n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(3n+1){clear:both}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:39px 26px 0}}.Pagination-module--pagination--d61cb{display:flex;margin-top:52px}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b{text-align:left;width:50%}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d{color:var(--color-secondary);font-size:26px;font-weight:700}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d:focus,.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d:hover{color:var(--color-primary)}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d.Pagination-module--disable--7e105{color:#3f485a;pointer-events:none}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8{text-align:right;width:50%}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff{color:var(--color-secondary);font-size:26px;font-weight:700}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff:focus,.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff:hover{color:var(--color-primary)}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff.Pagination-module--disable--7e105{color:#3f485a;pointer-events:none}.Button-module--button--b1113{border:1px solid var(--color-button-border);border-radius:20px;color:var(--color-button-color);display:inline-block;font-size:16px;font-weight:400;height:40px;line-height:40px;margin-left:auto;margin-right:auto;padding:0 26px;text-align:center;text-decoration:none}.Button-module--button--b1113:focus,.Button-module--button--b1113:hover{color:#5c92ff}.ThemeSwitcher-module--themeSwitcher--8a77f{--color:var(--color-theme-switcher)}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b{align-items:center;background:transparent;border:0;cursor:pointer;display:flex;justify-content:center;outline:0}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b svg{stroke:var(--color);pointer-events:none;transition:stroke .4s}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b:hover{--color:var(--color-theme-switcher-hover)}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--moon--10537{stroke-dasharray:0 1px;opacity:0;transition:stroke-dasharray .2s ease-in,opacity .4s ease-in}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--sun--2163a{stroke-dasharray:1px 1px;opacity:1;transition:stroke-dasharray .2s ease-in,opacity .4s ease-in}.ThemeSwitcher-module--themeSwitcher--8a77f.ThemeSwitcher-module--dark--6db0c .ThemeSwitcher-module--moon--10537{stroke-dasharray:1px 1px;opacity:1}.ThemeSwitcher-module--themeSwitcher--8a77f.ThemeSwitcher-module--dark--6db0c .ThemeSwitcher-module--sun--2163a{stroke-dasharray:0 1px;opacity:0}.Author-module--author--cbd31 .Author-module--photo--9787b{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--cbd31 .Author-module--photo--9787b img{border-radius:50%}.Author-module--author--cbd31 .Author-module--title--cf7e5{font-size:18px;font-weight:600;line-height:29.25px;margin:0}.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17,.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17:focus,.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17:hover{color:var(--color-typographic-base-font)}.Author-module--author--cbd31 .Author-module--subtitle--86ec5{color:#7f8ba4;line-height:26px;margin-bottom:26px}.Author-module--author--cbd31 .Author-module--titleContainer--4f576{align-items:center;display:flex;justify-content:space-between;margin:13px 0}.Icon-module--icon--1d7da{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--09178{margin-bottom:26px}.Contacts-module--contacts--09178 .Contacts-module--list--9670b{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:165px;padding:0}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0{align-content:center;align-items:center;border:1px solid var(--color-contacts-border);border-radius:50%;display:flex;height:40px;justify-content:center;line-height:40px;margin:6.5px;padding:0;text-align:center;width:40px}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0{border:0;color:var(--color-typographic-base-font);cursor:pointer;display:flex}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0:focus,.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0:hover{color:var(--color-typographic-link-p-font)}.Copyright-module--copyright--2c602{color:#7f8ba4;font-size:14px}.Menu-module--menu--113a9{margin-bottom:26px}.Menu-module--menu--113a9 .Menu-module--list--e1ae3{list-style:none;margin:0;padding:0}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679{margin:13px 0;padding:0}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02{border:0;color:var(--color-typographic-base-font);font-size:16px;font-weight:400}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02:focus,.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02.Menu-module--active--6cb74{border-bottom:1px solid var(--color-typographic-base-font);color:var(--color-typographic-base-font)}.Sidebar-module--sidebar--1bfa1{width:100%}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:26px 19.5px 0;position:relative}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0:after{background:var(--color-sidebar-border);background:linear-gradient(to bottom,var(--color-sidebar-border) 0,var(--color-sidebar-border) 48%,var(--color-sidebar-border-fade) 100%)}@media screen and (min-width:685px){.Sidebar-module--sidebar--1bfa1{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0:after{bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1bfa1{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:39px}}.Author-module--author--1c58d{border-top:1px solid var(--color-page-border);line-height:26px;margin-bottom:52px;margin-top:26px;max-width:640px;padding-top:26px}.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647{display:block;text-decoration:underline}.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647:focus,.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647:hover{color:var(--color-typographic-link-s-font)}@media screen and (min-width:685px){.Author-module--author--1c58d{margin-left:auto;margin-right:auto}}.Content-module--content--80d58{margin:0 auto;max-width:945px;padding:0 13px}.Content-module--content--80d58 .Content-module--title--09504{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:640px;text-align:center}.Content-module--content--80d58 .Content-module--body--726c2 figure{margin-bottom:26px}.Content-module--content--80d58 .Content-module--body--726c2 figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--80d58 .Content-module--body--726c2 figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:640px}.Content-module--content--80d58 .Content-module--body--726c2 a{text-decoration:underline}.Content-module--content--80d58 .Content-module--body--726c2 *{margin-left:auto;margin-right:auto;max-width:640px}.Content-module--content--80d58 .Content-module--body--726c2 h2>a{visibility:hidden}.Content-module--content--80d58 .Content-module--body--726c2 h2>a>svg{fill:var(--color-typographic-base-font)}.Content-module--content--80d58 .Content-module--body--726c2 img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--80d58{padding:0}.Content-module--content--80d58 .Content-module--title--09504{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--80d58 .Content-module--body--726c2,.Content-module--content--80d58 .Content-module--body--726c2 p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--80d58 .Content-module--body--726c2 h2>a{padding-right:13px;visibility:unset}}.Meta-module--meta--dae0a .Meta-module--date--4d30d{font-style:italic}.Tags-module--tags--18589{margin-bottom:13px}.Tags-module--tags--18589 .Tags-module--list--82ae6{list-style:none;padding:0}.Tags-module--tags--18589 .Tags-module--list--82ae6 .Tags-module--item--52015{display:inline-block;margin:6.5px 0}@media screen and (min-width:685px){.Tags-module--tags--18589 .Tags-module--list--82ae6 .Tags-module--item--52015:first-child{margin-left:0;padding-left:0}}.Post-module--post--3a994 .Post-module--content--3c6e5{margin:0 auto}.Post-module--post--3a994 .Post-module--comments--d3b99,.Post-module--post--3a994 .Post-module--footer--f8705{margin:0 auto;max-width:640px;padding:0 13px}.Post-module--post--3a994 .Post-module--buttons--2972d{align-items:center;display:flex;justify-content:center;margin:26px 0 0;text-align:center}.Post-module--post--3a994 .Post-module--buttons--2972d .Post-module--buttonArticles--d793a{margin:0 13px 0 0}@media screen and (min-width:960px){.Post-module--post--3a994 .Post-module--comments--d3b99,.Post-module--post--3a994 .Post-module--footer--f8705{padding:0}.Post-module--post--3a994 .Post-module--buttons--2972d{left:30px;margin:0 13px 0 0;max-width:none;position:fixed;top:30px}}</style><title data-gatsby-head="true">createRoot()에 render()를 호출하면 어떤 일이 일어날까? - Blog by Jason Kang</title><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>            
              (adsbygoogle = window.adsbygoogle || []).push({
                google_ad_client: "ca-pub-2002611361597206",
                enable_page_level_ads: true
              });
          </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-8BHCT1V21F"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-8BHCT1V21F', {"send_page_view":false});
      }
      </script><link rel="alternate" type="application/rss+xml" title="Blog by Jason Kang" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=110dbcaf7b73f2d646b07137b9e3af54" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=110dbcaf7b73f2d646b07137b9e3af54"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><script>
          void function() {
            var cachedMode;

            try {
              var preferredTheme = JSON.parse(localStorage.getItem('diesel:theme-atom'));

              if (preferredTheme && preferredTheme.mode) {
                cachedMode = preferredTheme.mode;
              }
            } catch (err) { }

            function setTheme(newTheme) {
              document.documentElement.className = newTheme;
            }

            var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

            setTheme(cachedMode || (darkQuery.matches ? 'dark' : 'light'));
          }()
        </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--2c933"><div class="Post-module--post--3a994"><div class="Post-module--buttons--2972d"><a class="Button-module--button--b1113 Post-module--buttonArticles--d793a" href="/">All Articles</a></div><div class="Post-module--content--3c6e5"><div class="Content-module--content--80d58"><h1 class="Content-module--title--09504">createRoot()에 render()를 호출하면 어떤 일이 일어날까?</h1><div class="Content-module--body--726c2"><p>요즘 힙한(?) <a href="https://vitejs.dev/" target="_blank" rel="nofollow noopener noreferrer">vite</a>로 React 프로젝트를 시작하면 <code class="language-text">main.tsx</code>에 아래와 같은 코드가 나타난다. (사실 create-react-app으로 해도 마찬가지)</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// main.tsx</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>StrictMode<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom/client'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>StrictMode<span class="token operator">></span>
    <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>StrictMode<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">index.html</code>에 아래 코드가 들어있기 때문에, <code class="language-text">&lt;div id="root"></code>에 접근할 수 있다.</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- index.html --></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/src/main.tsx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>오픈소스라 그런지 변수명을 아주 잘 지었기 때문에, <code class="language-text">main.tsx</code>에서 이루고자 하는 것은</p>
<ol>
<li><code class="language-text">ReactDOM</code>에 <code class="language-text">&lt;div id="root"></code>를 사용해서 <code class="language-text">root</code>를 만들고</li>
<li>그 root에 <code class="language-text">&lt;App /></code>을 파라미터로 해서 <code class="language-text">.render()</code>라는 함수를 호출한다.</li>
</ol>
<p><code class="language-text">ReactDOM</code>은 <code class="language-text">react-dom/client</code>에서 default로 export된 값이기 때문에, <code class="language-text">main.tsx</code>는 아래처럼 간소화(?) 될 수 있다.</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// main.tsx</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>StrictMode<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createRoot<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/client'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>

<span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>StrictMode<span class="token operator">></span>
    <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>StrictMode<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">react-dom</code> 패키지의 소스코드를 분석해서, 이것이 어떻게 이루어지는지 알아보려고 한다. 그럼 <code class="language-text">createRoot</code>부터 확인한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'createRoot(...): Target container is not a DOM element.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">warnIfReactDOMContainerInDEV</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">isValidContainer()</code>를 호출해서, <code class="language-text">container</code>가 <code class="language-text">HTMLElement</code>인지 확인한다.
<code class="language-text">warnIfReactDOMContainerInDEV()</code>는 container를 추가로 검증하는 함수이다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">warnIfReactDOMContainerInDEV</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">ELEMENT_NODE</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>tagName <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'BODY'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'createRoot(): Creating roots directly with document.body is '</span> <span class="token operator">+</span> <span class="token string">'discouraged, since its children are often manipulated by third-party '</span> <span class="token operator">+</span> <span class="token string">'scripts and browser extensions. This may lead to subtle '</span> <span class="token operator">+</span> <span class="token string">'reconciliation issues. Try using a container element created '</span> <span class="token operator">+</span> <span class="token string">'for your app.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isContainerMarkedAsRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'You are calling ReactDOMClient.createRoot() on a container that was previously '</span> <span class="token operator">+</span> <span class="token string">'passed to ReactDOM.render(). This is not supported.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'You are calling ReactDOMClient.createRoot() on a container that '</span> <span class="token operator">+</span> <span class="token string">'has already been passed to createRoot() before. Instead, call '</span> <span class="token operator">+</span> <span class="token string">'root.render() on the existing root instead if you want to update it.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>첫번째 if문은 <code class="language-text">&lt;body></code>를 container로 사용할 수 없다는 것이고, 아래 if문은 container가 이미 root로 등록된 tag의 child component인지를 확인하는 함수이다. 즉 또다른 tag를 <code class="language-text">index.html</code>에 추가하지 않는다면 앞에서 언급한 <code class="language-text">&lt;div id="root"></code>만 root가 될 수 있다.</p>
<p><code class="language-text">createRoot()</code>를 마저 살펴보자</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> ConcurrentRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isStrictMode<span class="token punctuation">,</span> concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span> identifierPrefix<span class="token punctuation">,</span> onRecoverableError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>container는 <code class="language-text">&lt;div id="root"></code>이고, options는 말 그대로 필수항목은 아닌데 <code class="language-text">identifierPrefix</code>와 <code class="language-text">onRecoverableError</code>를 받을 수 있다.
<code class="language-text">identifierPrefix</code>는 <a href="https://beta.reactjs.org/reference/react/useId" target="_blank" rel="nofollow noopener noreferrer">useId</a>로 id를 생성할 때 앞에 prefix로 붙일 string을 지정하는 역할이다. 예를들면 그냥 <code class="language-text">useId()</code>를 호출할 경우 <code class="language-text">r0</code>이라는 값을 리턴하는데, <code class="language-text">jason</code>과 같은 prefix를 넣어주면 <code class="language-text">jasonr0</code>을 리턴한다. <code class="language-text">onRecoverableError</code>는 렌더링하다가 에러가 발생하는 경우 호출하는 함수이다. console.error()가 디폴트인데, 만약 다르게 뭔가를 하고싶다면 함수를 보낼 수 있다. 하지만 굳이???</p>
<p>계속 보자면, <code class="language-text">createContainer()</code>는 내부적으로 <code class="language-text">createRiberRoot()</code>를 호출해서 <code class="language-text">FiberRootNode</code>를 return한다.</p>
<p>Fiber라는 개념에 대해 생소할 수 있는데, Fiber에 관해서는 <a href="https://jasonkang14.github.io/react/what-is-fiber-architecture" target="_blank" rel="nofollow noopener noreferrer">이 포스트</a>에서 조금 자세하게 다뤘다. 간단하게 설명하면 Fiber는 VirtualDOM Tree에서 각 React Element를 나타내는 node이다.</p>
<p><code class="language-text">FiberRootNode</code>는 Fiber들의 root라고 보면 된다. <code class="language-text">&lt;div id="root"></code>가 VirtualDom Tree에서는 <code class="language-text">FiberRootNode</code>이다. 그림으로 보자면 이런 느낌이다.</p>
<p><img src="https://i.imgur.com/8vWRrP6.png" alt="virtual-dom-tree"></p>
<p>이제 <code class="language-text">FiberRootNode</code>를 살펴본다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> identifierPrefix<span class="token punctuation">,</span> onRecoverableError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// attribute들 중에 `null`인 것들과 상수인 것들은 일단 생략했다. </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>eventTimes <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTimes <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>entanglements <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>identifierPrefix <span class="token operator">=</span> identifierPrefix<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRecoverableError <span class="token operator">=</span> onRecoverableError<span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedUpdaters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> pendingUpdatersLaneMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingUpdatersLaneMap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> _i <span class="token operator">&lt;</span> TotalLanes<span class="token punctuation">;</span> _i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pendingUpdatersLaneMap<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token literal-property property">ConcurrentRoot</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_debugRootType <span class="token operator">=</span> hydrate <span class="token operator">?</span> <span class="token string">'hydrateRoot()'</span> <span class="token operator">:</span> <span class="token string">'createRoot()'</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token literal-property property">LegacyRoot</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_debugRootType <span class="token operator">=</span> hydrate <span class="token operator">?</span> <span class="token string">'hydrate()'</span> <span class="token operator">:</span> <span class="token string">'render()'</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>모든 파라미터가 <code class="language-text">createContainer()</code>에서 오는데, <code class="language-text">hydrate</code>는 false라서 무시한다. <code class="language-text">hydrate</code>는 Server-Side Rendering에서 사용되는데, 그건 기회가 되면 나중에 훑어보도록 해야겠다. 그럼 우리에게 남은 것은</p>
<ol>
<li>containerInfo</li>
<li>tag</li>
<li>identifierPrefix</li>
<li>onRecoverableError</li>
</ol>
<p>하나씩 확인해본다. <code class="language-text">createContainer()</code>를 호출하는 곳과, <code class="language-text">createContainer()</code>를 비교해보면</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> ConcurrentRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isStrictMode<span class="token punctuation">,</span> concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span> identifierPrefix<span class="token punctuation">,</span> onRecoverableError<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">,</span> isStrictMode<span class="token punctuation">,</span> concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span> identifierPrefix<span class="token punctuation">,</span> onRecoverableError<span class="token punctuation">,</span> transitionCallbacks</span><span class="token punctuation">)</span></code></pre></div>
<ol>
<li><code class="language-text">containerInfo === container</code>이다. 이 경우에는 <code class="language-text">&lt;div id="root"></code>이다.</li>
<li><code class="language-text">tag</code>는 <code class="language-text">ConcurrentRoot</code>인데 파일에 1로 선언된 상수이다. 리액트는 다양한 값들을 상수로 활용하는데, 아마 계속 찾아보면 보이지 않을까 싶다.</li>
<li><code class="language-text">identifierPrefix</code>와 <code class="language-text">onRecoverableError</code>위에서 언급한 것처럼 <code class="language-text">createRoot()</code>을 호출할 때 사용되는 optional parameter이다.</li>
</ol>
<p><code class="language-text">Concurrent</code>라는 개념에 대해 조금 짚고 넘어가자면, React 18에서 추가된 <a href="https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react" target="_blank" rel="nofollow noopener noreferrer">렌더링 효율 개선 방안</a>이다. 요약하면 컴포넌트의 비동기적 렌더링과 병렬로 처리되는 업데이트를 가능하게 하여, 렌더링 성능과 사용자 경험을 개선하는 데 큰 역할을 한다. React16에 추가된 Fiber의 활용을 극대화한 것이라고 볼 수 있다.</p>
<p><code class="language-text">createLaneMap()</code>함수를 짚고 넘어가자면, V8엔진에서 메모리를 최적화 하기위한 방법이다. <code class="language-text">createLaneMap()</code>은 숫자로 이루어진 array를 리턴하는데, JavaScript array에 값을 <code class="language-text">push()</code>해서 array를 생성하는 함수이다.</p>
<p>array는 <code class="language-text">HOLEY_ELEMENTS</code>와 <code class="language-text">PACKED_ELEMENTS</code>로 구분된다.
array를 선언할 때, 아래처럼 비어있는 array를 먼저 선언하고 나중에 채우면 <code class="language-text">HOLEY_ELEMENTS</code>가 된다고 한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
array<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">;</span></code></pre></div>
<p>이와 다르게 처음부터 가득차게 채우면 <code class="language-text">PACKED_ELEMENTS</code>가 된다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">HOLEY_ELEMENTS</code>의 경우에는 garbage collected되더라도 메모리에 빈 공간을 남겨둬서 memory fragmentation을 야기할 수 있다. 만약에 값이 추가될 예정인지 아닌지 알 수 없다면, <code class="language-text">new Array(3)</code>으로 선언하지 말고, empty array를 선언한 후에 <code class="language-text">.push()</code>를 호출해야한다. 메모리를 효율적으로 사용하기 위한 리액트의 노력이라고 봐주면 되겠다.</p>
<p>뒤에서 다시 언급하겠지만 <code class="language-text">lane</code>은 업데이트 종류에 따라 배정된 상수이다. <code class="language-text">laneMap</code>은 array인데, <code class="language-text">TotalLanes</code>의 길이만큼 array를 생성해서 리턴한다. 그리고 특정 업데이트가 발생하면, 해당 업데이트의 종류를 <code class="language-text">lane</code>으로 확인한 후에, <code class="language-text">laneMap</code>에 해당 업데이트가 요청된 시간을 할당한다.</p>
<p>다시 <code class="language-text">FiberRootNode</code>를 생성하는 <code class="language-text">createFiberRoot()</code>로 돌아간다. <code class="language-text">createFiberRoot()</code>는 <code class="language-text">FiberRootNode</code>에 값들을 할당한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">MANY_PARAMETERS</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> identifierPrefix<span class="token punctuation">,</span> onRecoverableError<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> isStrictMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">element</span><span class="token operator">:</span> initialChildren <span class="token comment">// initialChildren == null,</span>
      <span class="token literal-property property">isDehydrated</span><span class="token operator">:</span> hydrate<span class="token punctuation">,</span> <span class="token comment">// hydrate == false</span>
      <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">transitions</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">pendingSuspenseBoundaries</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    uninitializedFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> _initialState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">FiberRootNode</code>에 파라미터로 넘겨주는 <code class="language-text">containerInfo</code>는 <code class="language-text">&lt;div id="root"></code>인데, <code class="language-text">root.containerInfo</code>에 할당된다. 이건 뒤에 나오니까 기억해두도록 한다.</p>
<p>그리고 <code class="language-text">root.current</code>는 기존에 <code class="language-text">null</code>이었는데 <code class="language-text">createHostRootFiber()</code>가 return하는 <code class="language-text">HostRoot</code>가 할당된다. React Component가 parent-child관계를 갖는 것처럼 <code class="language-text">current</code>에 할당해서 <code class="language-text">HostRoot</code>를 <code class="language-text">RootFiberNode</code>의 자식 node로 관리한다는 개념으로 이해하면 된다. <code class="language-text">HostRoot</code>는 그냥 <code class="language-text">FiberNode</code>중에 하나다. React에는 FiberNode의 종류들도 <a href="https://github.com/facebook/react/blob/9e3b772b8cabbd8cadc7522ebe3dde3279e79d9e/packages/react-reconciler/src/ReactWorkTags.js" target="_blank" rel="nofollow noopener noreferrer">숫자로 관리한다</a>. 코드를 보면 <code class="language-text">HostRoot</code>은 3에 해당하고, <code class="language-text">createHostRootFiber</code>는 <code class="language-text">createFiber()</code>라는 함수에 해당 숫자를 넘겨줘서 <code class="language-text">HostRoot</code>를 생성한다.</p>
<p>위에서 나타낸 VirtualDOM Tree는 사실상 이런모양이다.</p>
<p><img src="https://i.imgur.com/eKb5taU.png" alt="virtual-dom-tree"></p>
<p>이제 <code class="language-text">initializeUpdateQueue()</code>를 호출해서, <code class="language-text">HostRoot</code>에 <code class="language-text">updateQueue</code>를 할당한다. React에서 Fiber개념을 도입하면서, Re-rendering에 업데이트라는 단어를 혼용해서 한다. <code class="language-text">updateQueue</code> state가 변경되면서 re-rendering이 일어날때, 화면 변화를 일으키는 queue라고 생각하면 된다.</p>
<p><code class="language-text">updateQueue</code>는 아래와 같은 구조이다</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> queue <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">baseState</span><span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
  <span class="token literal-property property">firstBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">interleaved</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lanes</span><span class="token operator">:</span> NoLanes
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">effects</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">state</code>가 변경되면서 rendering이 어떻게 되는지에 대해도 포스트 하려고 하는데, <code class="language-text">updateQueue</code>는 다음 포스트에서 다루겠다. 다시 <code class="language-text">createRoot()</code>로 돌아가면,</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> rootContainerElement <span class="token operator">=</span> container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span> <span class="token operator">?</span> container<span class="token punctuation">.</span>parentNode <span class="token operator">:</span> container<span class="token punctuation">;</span>
  <span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span>rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">markContainerAsRoot()</code>를 같이 보자.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span><span class="token parameter">hostRoot<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">[</span>internalContainerInstanceKey<span class="token punctuation">]</span> <span class="token operator">=</span> hostRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">markContainerAsRoot()</code>이 파라미터로 넘겨받은 <code class="language-text">hostRoot</code>는 <code class="language-text">HostRoot</code>이고, <code class="language-text">node</code>는 <code class="language-text">&lt;div id="root"></code>이다. 그리고 <code class="language-text">internalContainerInstanceKey</code>는 <code class="language-text">container</code>를 나타내는 string이다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> randomKey <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> internalContainerInstanceKey <span class="token operator">=</span> <span class="token string">'__reactContainer$'</span> <span class="token operator">+</span> randomKey<span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">&lt;div id="root"></code>와 <code class="language-text">HostRoot</code> 연결시키는 것이라고 볼 수 있다. 리액트에서 업데이트가 발생하면, 자식들부터 업데이트를 시작해서 부모 node들로 타고 올라오는데, <code class="language-text">&lt;div id="root"></code>와 연결된 <code class="language-text">HostRoot</code>를 만나는 순간 이제 그만 확인하고 업데이트를 멈추라는 것을 알릴 수 있다.</p>
<p><img src="https://i.imgur.com/viuBWKI.png" alt="div-root-with-container-instance-key"></p>
<p>그리고 이제 <code class="language-text">&lt;div id="root"></code>에 모든 이벤트리스너를 붙인다. 이건 React 17에서 업데이트된 사항인데, 기존에는 모든 이벤트를 <code class="language-text">body</code>에 붙였는데, React 17부터 <code class="language-text">&lt;div id="root"></code>에 붙인다.</p>
<p><img src="https://i.imgur.com/kR5Ic4j.png" alt="root-node-listens-to-all-the-events"></p>
<p>그렇게 이벤트리스너를 모두 <code class="language-text">&lt;div id="root"></code>에 붙이면, <code class="language-text">ReactDOMRoot</code>를 리턴한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter">internalRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> internalRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">FiberRootNode</code>를 <code class="language-text">this._internalRoot</code>에 할당하는 것으로 <code class="language-text">createRoot()</code>는 마무리된다. 요악하면 아래와 같은 과정을 거친다.</p>
<ol>
<li><code class="language-text">RootFiberNode</code>생성</li>
<li><code class="language-text">RootFiberNode</code>의 직계 자식 node로 <code class="language-text">HostRoot</code>생성</li>
<li><code class="language-text">HostRoot</code>를 <code class="language-text">&lt;div id="root"></code>와 연결</li>
<li><code class="language-text">&lt;div id="root"></code>에 리액트에서 발생하는 모든 업데이트 할당</li>
</ol>
<p>이렇게 해서 <code class="language-text">root</code>가 생성된다.</p>
<p>해당 <code class="language-text">ReactDOMRoot</code>가 <code class="language-text">render()</code> method를 호출한다. 이제 <code class="language-text">render()</code>를 하나씩 쪼개보자.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span> 

  <span class="token comment">// root === FiberRootNode이기 때문에 에러는 발생하지 않는다. </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Cannot update an unmounted root.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// `render()`를 호출할 때 arguments가 하나밖에 없기 때문에 `arguments[1] === undefined`라서 bypass한다.</span>
  <span class="token comment">// 사실상 없어도 되는게 아닌가 생각한다</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'render(...): does not support the second callback argument. '</span> <span class="token operator">+</span> <span class="token string">'To execute a side effect after rendering, declare it in a component body with useEffect().'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidContainer</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'You passed a container to the second argument of root.render(...). '</span> <span class="token operator">+</span> <span class="token string">"You don't need to pass it again since you already passed it to create the root."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'You passed a second argument to root.render(...) but it only accepts '</span> <span class="token operator">+</span> <span class="token string">'one argument.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> container <span class="token operator">=</span> root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token constant">COMMENT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> hostInstance <span class="token operator">=</span> <span class="token function">findHostInstanceWithNoPortals</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hostInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hostInstance<span class="token punctuation">.</span>parentNode <span class="token operator">!==</span> container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'render(...): It looks like the React-rendered content of the '</span> <span class="token operator">+</span> <span class="token string">'root container was removed without using React. This is not '</span> <span class="token operator">+</span> <span class="token string">'supported and will cause errors. Instead, call '</span> <span class="token operator">+</span> <span class="token string">"root.unmount() to empty a root's container."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">container</code>에 할당되는 <code class="language-text">root.containerInfo</code>는 <code class="language-text">&lt;div id="root"></code>이다. <code class="language-text">container.nodeType</code>은 <code class="language-text">COMMENT_NODE</code>가 아니기 때문에 if문 안으로 들어가고, <code class="language-text">root.current</code>는 <code class="language-text">RootFiberNode</code>의 child node에 해당하는 <code class="language-text">HostRoot</code>이다.</p>
<p><code class="language-text">findHostInstanceWithNoPortals()</code>는 <code class="language-text">host instance</code>를 찾는 함수인데, <code class="language-text">host instance</code>는 리액트 컴포넌트의 output을 스크린에 렌더하는 역할을 담당한다. DOM node라고 보면 된다. <code class="language-text">NoPortals</code>라는 조건이 붙으면서, portal이 아닌 것들 중에서 파라미터로 넘겨준 <code class="language-text">fiber</code>의 direct parent component를 찾아낸다.</p>
<p><code class="language-text">&lt;div id="root"></code>는 parent가 없기때문에, <code class="language-text">hostInstance</code>가 없어서 아래 if문은 bypass하고 <code class="language-text">updateContainer()</code>를 호출한다.</p>
<p>이제 <code class="language-text">updateContainer()</code>를 살펴보자.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>
<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
    <span class="token function">onScheduleRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> current$1 <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">var</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current$1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>여기서 <code class="language-text">element</code>은 <code class="language-text">&lt;App /></code>이고 <code class="language-text">container</code>는 <code class="language-text">FiberRootNode</code>이다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>
<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
    <span class="token function">onScheduleRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> current$1 <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">var</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current$1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">onScheduleRoot()</code>는 개발모드에서 React와 React Developer Tools, Redux DevTools와 같은 다양한 third-party 툴들을 React와 연결시키는 역할이다. 이를 통해 디버깅이 더 수월해진다는 장점이 있다. production mode에는 없으므로 렌더링과 직접적인 관련이 없으니 생략하고 지나가겠다.</p>
<p><code class="language-text">container.current</code>는 <code class="language-text">HostRoot</code>이고, <code class="language-text">requestEventTime()</code>은 현재 timestamp를 리턴한다. <code class="language-text">requestedUpdateLane</code>은 업데이트 우선순위를 리턴한다.</p>
<p><code class="language-text">lane</code>은 React18에서 도입된 개념인데, 단어만 보자면 자동차 도로에서 차선을 나타낸다. 1차선의 차량이 가장 빠르고, 뒤로 갈수록 점점 느려지는 것을 생각해보면, 업데이트의 중요도에 따라서 <code class="language-text">lane</code>을 배정한다고 이해하면 된다. <code class="language-text">lane</code>은 미리 지정된 상수인데, 우선순위는 다음에 기회가 되면 자세히 알아봐야겠다.</p>
<p>리액트 렌더링에는 <code class="language-text">reconciler</code>가 활용된다. <code class="language-text">reconciler</code>는 우리말로 하면 중재자 정도인데, 컴포넌트에서 업데이트가 일어날 때 업데이트의 우선순위를 판단해서, 우선순위대로 업데이트 사항을 반영한다. 여기서는 <code class="language-text">DefaultEventPriority</code>라는 상수가 리턴된다 (숫자 16). 찾아보니 숫자의 크기가 업데이트 순서와는 관계가 없는 것 같은데, 이건 나중에 state 업데이트와 연관된 렌더링에 대해 찾아볼 때 조금 더 알아보겠다.</p>
<p>계속 이어서 보자면</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>
<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token punctuation">{</span>
    <span class="token function">markRenderScheduled</span><span class="token punctuation">(</span>lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didWarnAboutNestedUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didWarnAboutNestedUpdates <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Render methods should be a pure function of props and state; '</span> <span class="token operator">+</span> <span class="token string">'triggering nested component updates from render is not allowed. '</span> <span class="token operator">+</span> <span class="token string">'If necessary, trigger nested updates in componentDidUpdate.\n\n'</span> <span class="token operator">+</span> <span class="token string">'Check the render method of %s.'</span><span class="token punctuation">,</span> <span class="token function">getComponentNameFromFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Unknown'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">markRenderScheduled()</code>는 <code class="language-text">injectedProfilingHooks</code>가 있다면, 렌더링 계획에 대해 업데이트를 하는데, 여기서는 null이라서 아무런 일도 일어나지 않는다. <a href="https://reactjs.org/docs/profiler.html" target="_blank" rel="nofollow noopener noreferrer">React Profiler</a>를 사용했을 때 사용된다. 지금은 <code class="language-text">Profiler</code>가 없기때문에 아무런 효과가 없다.</p>
<p><code class="language-text">getContextForSubtree()</code>는 <code class="language-text">context</code> 정보를 가져오는 역할이다. <code class="language-text">useContext</code> 훅도 내부적으로는 <code class="language-text">getContextForSubtree()</code>를 호출해서 context정보를 가져온다고 보면된다. 여기서는 <code class="language-text">parentComponent</code>가 null이라 <code class="language-text">{}</code>를 리턴하지만, <code class="language-text">parentComponent</code>가 있다면 그 정보를 활용해서 context정보를 리턴한다. <code class="language-text">container.context</code>는 null이기 때문에, <code class="language-text">{}</code>를 할당한다.</p>
<p>이후 if문은 바이패스하는데, 저 에러문구는 본적이 있다. <code class="language-text">render()</code>에서—함수형 컴포넌트를 사용한다면 return에서—사이드 이펙트가 발생하면 보여주는 메세지이다. 예를들면 <code class="language-text">render()</code>안에서 state를 업데이트 하거나, prop으로 넘겨주는 값을 수정하는 것이다. 라이브러리를 잘못 사용할 때도 종종 발생하는 것 같다. <a href="https://github.com/fkhadra/react-toastify/issues/406#issuecomment-564630604" target="_blank" rel="nofollow noopener noreferrer">error from react-toastify</a></p>
<p>계속 가보자면…</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  
  <span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> element
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'render(...): Expected the last optional `callback` argument to be a '</span> <span class="token operator">+</span> <span class="token string">'function. Instead received: %s.'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current$1<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current$1<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">entangleTransitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current$1<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">createUpdate()</code>는 <code class="language-text">update</code>라는 객체를 리턴한다. 아래 모양이다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">eventTime</span><span class="token operator">:</span> eventTime<span class="token punctuation">,</span>
  <span class="token literal-property property">lane</span><span class="token operator">:</span> lane<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> UpdateState<span class="token punctuation">,</span>
  <span class="token literal-property property">payload</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>update에 사용되는 queue가 linked list이기 때문에 <code class="language-text">next</code>라는 key를 가지고 있는 것 같다. 해당 객체가 <code class="language-text">enqueueUpdate</code>에 넘겨져서 렌더링 queue에 들어가기 때문에 pointer로 활용된다. <code class="language-text">update.payload</code>에 할당되는 <code class="language-text">element</code>는 <code class="language-text">main.tsx</code>에 선언된 <code class="language-text">&lt;App /></code>이다. callback은 null이니 bypass된다.</p>
<p><code class="language-text">enqueueUpdate()</code>에 전달되는 <code class="language-text">current$1</code>은 <code class="language-text">HostRoot</code>이고, 위에 설명한 update 객체, lane은 업데이트 우선순위를 나타내는 상수이다. 호출하면 <code class="language-text">FiberRootNode</code>를 리턴한다. <code class="language-text">enqueueUpdate()</code>를 따라가보자</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only occurs if the fiber has been unmounted.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> sharedQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyProcessingQueue <span class="token operator">===</span> sharedQueue <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didWarnUpdateInsideUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'An update (setState, replaceState, or forceUpdate) was scheduled '</span> <span class="token operator">+</span> <span class="token string">'from inside an update function. Update functions should be pure, '</span> <span class="token operator">+</span> <span class="token string">'with zero side-effects. Consider using componentDidUpdate or a '</span> <span class="token operator">+</span> <span class="token string">'callback.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      didWarnUpdateInsideUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>기억을 되돌려보면, <code class="language-text">initializeUpdateQueue(uninitializedFiber)</code>를 호출해서 <code class="language-text">HostRoot.updateQueue</code>에 아래 queue를 할당했다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> queue <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">baseState</span><span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
  <span class="token literal-property property">firstBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">interleaved</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lanes</span><span class="token operator">:</span> NoLanes
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">effects</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>이제 이 queue가 <code class="language-text">updateQueue</code>가 된다. 처음 렌더링이 발생하는 것이기 때문에, <code class="language-text">currentlyProcessingQueue</code>는 null이라서 if문은 bypass한다. 계속 이어서 보자.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUnsafeClassRenderPhaseUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is an unsafe render phase update. Add directly to the update</span>
    <span class="token comment">// queue so we can process it immediately during the current render.</span>
    <span class="token keyword">var</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the first update. Create a circular list.</span>
      update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span> <span class="token comment">// Update the childLanes even though we're most likely already rendering</span>
    <span class="token comment">// this fiber. This is for backwards compatibility in the case where you</span>
    <span class="token comment">// update a different component during render phase than the one that is</span>
    <span class="token comment">// currently renderings (a pattern that is accompanied by a warning).</span>

    <span class="token keyword">return</span> <span class="token function">unsafe_markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">enqueueConcurrentClassUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> sharedQueue<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>최초 업데이트기때문에 <code class="language-text">isUnsafeClassRenderPhaseUpdate()</code>는 <code class="language-text">false</code>를 리턴해서 else문으로 간다. 그 전에 <strong>render phase</strong>를 언급하고 넘어갈 필요가 있다.</p>
<p>리액트 렌더링은 두 단계의 phase로 나누어진다. 하나는 방금 언급한 <strong>render phase</strong>이고 다른 하나는 <strong>commit phase</strong>이다.</p>
<p>간단히 설명하면 <code class="language-text">render phase</code>는 React가 DOM Tree와 VirtualDOM Tree를 비교하면서 <a href="https://jasonkang14.github.io/react/what-is-fiber-architecture" target="_blank" rel="nofollow noopener noreferrer">이전 포스트</a>에서 언급한 <code class="language-text">work-in-progress queue</code>를 생성해서 화면을 업데이트를 준비하는 과정이다. <code class="language-text">commit phase</code>는 <code class="language-text">render phase</code>에서 작업된 변경상태들을 화면에 반영하는 단계이다. 최초 렌더링이기 때문에 업데이트할게 없고, 따라서 <code class="language-text">work-in-progress queue</code>가 필요 없는 상황이기 때문에, <code class="language-text">isUnsafeClassRenderPhaseUpdate()</code>가 <code class="language-text">false</code>를 리턴하는 것이다. state 변경으로 인해 update가 발생하더라도 문제가 없다면 <code class="language-text">false</code>일 것 같다.</p>
<p>그럼 이제 <code class="language-text">enqueueConcurrentClassUpdate()</code>를 확인해본다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">enqueueConcurrentClassUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> interleaved <span class="token operator">=</span> queue<span class="token punctuation">.</span>interleaved<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>interleaved <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span> 

    <span class="token function">pushConcurrentUpdateQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> interleaved<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    interleaved<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  queue<span class="token punctuation">.</span>interleaved <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">fiber</code>는 여전히 <code class="language-text">HostRoot</code>이고, <code class="language-text">queue</code>는 아래 객체이다. <code class="language-text">update</code>는 업데이트를 발생시킨 timestamp와 lane정보를 가지고있다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">interleaved</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lanes</span><span class="token operator">:</span> NoLanes
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>
<p><code class="language-text">interleaved</code>라는 단어는 무언가를 번갈아가면서 한다는 뜻인데, 여기서 어떤 용도인지는 아직 잘 파악이 되지 않는다. else문의 코드로 유추할 때는 하나씩 업데이트를 쳐내기 위해 사용되는 값인 것 같다. 지금은 <code class="language-text">interleaved == null</code>이기 때문에, update.next에 <code class="language-text">update</code>자신을 할당하고, <code class="language-text">pushConcurrentUpdateQueue()</code>를 호출한다. <code class="language-text">concurrentQueues</code>는 array인데, queue이기때문에 업데이트가 필요한 queue가 하나씩 <code class="language-text">.push()</code>되어 끝에 추가되는 구조이다.</p>
<p><code class="language-text">queue.interleaved</code>에 <code class="language-text">update</code>를 할당하고, <code class="language-text">markUpdateLaneFromFiberToRoot()</code>를 호출한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token parameter">sourceFiber<span class="token punctuation">,</span> lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sourceFiber<span class="token punctuation">.</span>lanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>sourceFiber<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> alternate <span class="token operator">=</span> sourceFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    alternate<span class="token punctuation">.</span>lanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>alternate<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sourceFiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warnAboutUpdateOnNotYetMountedFiberInDEV</span><span class="token punctuation">(</span>sourceFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// Walk the parent path to the root and update the child lanes.</span>


  <span class="token keyword">var</span> node <span class="token operator">=</span> sourceFiber<span class="token punctuation">;</span>
  <span class="token keyword">var</span> parent <span class="token operator">=</span> sourceFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parent<span class="token punctuation">.</span>childLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>childLanes<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    alternate <span class="token operator">=</span> parent<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      alternate<span class="token punctuation">.</span>childLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>alternate<span class="token punctuation">.</span>childLanes<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warnAboutUpdateOnNotYetMountedFiberInDEV</span><span class="token punctuation">(</span>sourceFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    node <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">return</span> root<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">sourceFiber</code>는 <code class="language-text">HostRoot</code>이고 <code class="language-text">lane</code>은 상수이다. <code class="language-text">sourceFiber.lanes</code>는 <code class="language-text">lane</code>과 같은 상수인데, <code class="language-text">mergeLanes()</code>는 두 lane에 대해 bitwise OR operator를 사용한 값이다.</p>
<p><code class="language-text">alternate</code>도 fiber의 개념인데, commit phase가 지나고 DOM에 변경사항이 DOM Tree에 적용된 fiber를 <code class="language-text">current fiber</code>라고 칭하고, 변경사항이 반영중인 fiber를 <code class="language-text">work-in-progress fiber</code>라고 칭한다. alternate은 각각 서로를 나타낸다. <code class="language-text">current fiber</code>의 alternate은 <code class="language-text">work-in-progress fiber</code>이고, <code class="language-text">work-in-progress fiber</code>의 alternate은 <code class="language-text">current fiber</code>이다.</p>
<p><code class="language-text">return</code>도 fiber의 개념인데, VirtualDOM Tree에서 본인의 부모 node에 해당하는 값을 나타낸다. 하지만 return이라는 단어를 사용하는 이유는, 해당 fiber node에서 작업이 끝나면 return, 돌아가서 처리할 node를 나타내기 때문이다. 렌더링에서 업데이트는 자식노드(child node)를 모두 업데이트 한 후에 부모노드(return node)를 업데이트하기 때문에 return이라는 단어를 사용한 것 같다. 개념과 유사하게 <code class="language-text">parent</code>라는 변수에 해당 값을 할당한다. while문을 사용해서 업데이트 할 <code class="language-text">lane</code>을 배정한다고 볼 수 있다.</p>
<p>lane을 계산하는 과정이 모두 끝나면 최초 렌더링에서는 <code class="language-text">sourceFiber</code>가 <code class="language-text">HostRoot</code>이기 때문에 <code class="language-text">HostRoot</code>의 <code class="language-text">stateNode</code>인 <code class="language-text">FiberRootNode</code>를 리턴한다.</p>
<p>다시 <code class="language-text">updateContainer()</code>로 돌아가면…</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// react-dom.development.js</span>

<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current$1<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current$1<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">entangleTransitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current$1<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">root</code>가 <code class="language-text">FiberRootNode</code>라서 <code class="language-text">null</code>이 아니기 때문에 아래 두 함수를 실행한다. <code class="language-text">scheduleUpdateOnFiber()</code>부터 보자</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningInsertionEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'useInsertionEffect must not schedule updates.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlushingPassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didScheduleUpdateDuringPassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">markRootUpdated</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgressRootInterleavedUpdatedLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>workInProgressRootInterleavedUpdatedLanes<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRootExitStatus <span class="token operator">===</span> RootSuspendedWithDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended$1</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> workInProgressRootRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">checkForNestedUpdates()</code>는 <code class="language-text">useEffect()</code>안에서 <code class="language-text">setState()</code>를 실행하는 등으로 인해 무한루프가 발생하는 경우 에러를 던진다. <a href="https://react.dev/reference/react/useInsertionEffect" target="_blank" rel="nofollow noopener noreferrer">useInsertionEffect</a>는 styled-component나 emotion과 같은 CSS-in-JS 라이브러리 author들이 사용하는 훅이라고 한다. 실제로는 사용할 일이 없으니 역시 무시하고 지나간다.</p>
<p><code class="language-text">isFlushingPassiveEffects</code>를 이해하려면 <strong>passive effect</strong>를 먼저 알아야한다. <strong>passive</strong> 라는 단어는 수동적이라는 뜻인데, 화면에 렌더링을 마치고 발생하는 업데이트를 뜻한다. flushing 한다는 것은 변경사항을 DOM에 반영하는 것이다. 즉 <code class="language-text">isFlushingPassiveEffects</code>는 렌더링은 끝난 상태이고, <strong>뒤로 미뤄덨던 업데이트를 지금 반영중이냐</strong>를 확인하는 변수이다. 맞다면 <code class="language-text">didScheduleUpdateDuringPassiveEffects</code>라는 flag를 활성화하고 다음단계로 넘어간다.</p>
<p><code class="language-text">markRootUpdated</code>는 <code class="language-text">RootFiberNode</code>의 <code class="language-text">eventTimes</code>라는 attribute에 <code class="language-text">eventTime</code>을 할당해서, 값을 바꿔준다. 해당 lane의 업데이트가 언제 요청되었는지 저장해두는 것이다. <code class="language-text">root === workInProgressRoot</code>라는 조건은, 렌더링이 진행중일 때 새로운 업데이트가 들어왔는지를 확인하는 것인데, 지금은 최초렌더링이기 때문에 해당되지 않는다. 따라서 <code class="language-text">root</code> update의 schedule을 마치고 끝이난다.</p>
<p>상태 업데이트와 관련있는 <code class="language-text">beginWork()</code>라는 함수에 대해 언급하지 않고 마무리한다. 해당 함수에 대해서는, <code class="language-text">setState()</code>가 발생했을 때 리액트가 어떻게 화면을 업데이트 하는지에 대해 공부하면서 작성해보도록 하겠다.</p></div></div></div><div class="Post-module--footer--f8705"><div class="Meta-module--meta--dae0a"><p class="Meta-module--date--4d30d">Mar 20, 2023</p></div><div class="Tags-module--tags--18589"><ul class="Tags-module--list--82ae6"><li class="Tags-module--item--52015"><a class="Button-module--button--b1113" href="/tag/react/">React</a></li></ul></div><div class="Author-module--author--1c58d"><p class="Author-module--bio--08950">AI Enthusiast and a Software Engineer<a class="Author-module--twitter--90647" href="https://www.linkedin.com/in/byeongjinkang" rel="noopener noreferrer" target="_blank"><strong>Jason Kang</strong> on LinkedIn</a></p></div></div><div class="Post-module--comments--d3b99"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react/how-react-renders-jsx";window.___webpackCompilationHash="c384fbd57185d4574121";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-de7f247526557192b206.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-02abafd21f3ca3501462.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-b449ea18ac689b1b4d05.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-f25335f9ad4d1e083e1e.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-574bb2c842b72a4f56d6.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-87d8cb04f32ef1c28bb0.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-beeff9f32d60af6e299a.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-31ec0693570d1b8d96bc.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-dbf1278bb80575247891.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-e89bc401e74db52ece1a.js"]};/*]]>*/</script><script src="/app-de7f247526557192b206.js" async=""></script><script src="/framework-8a6e3897e8f1c55b7396.js" async=""></script><script src="/webpack-runtime-d5a8c8017fac52738241.js" async=""></script></body></html>